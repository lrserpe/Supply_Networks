#Group 5 

```{r}
library(dplyr)
library(ggplot2)
library(leaflet)
library(igraph)
```

```{r}
#Reformat data downloaded from BAST

df_all<- read.table("2013_A_S.txt", sep = ";", header=TRUE)

#Filter by land (column 9 for bayern)
df_A_2013 <- df_all %>% filter(Land %in% c(9))


#Filter by region 
#df_A_2013 <- df_A_2013 %>% filter((TKNR >2520 & TKNR < 2528) | (TKNR >2620 & TKNR < 2628))

```

```{r}
#read in B level data
df_all_B<- read.table("2013_B_S.txt", sep = ";", header=TRUE)

#Filter by land (column 9 for bayern)
df_B_2013 <- df_all_B %>% filter(Land %in% c(9))

#Filter by Date
df_date_range_B <- df_B_2013 %>% filter(Datum>130531 & Datum<130701 )
#write June data to csv
write.csv(df_date_range_B, file = "dataB_2013_BH_June.csv")


```



```{r}
df_BH <- read.csv("input/dataA_2013_BH_June.csv")
df_BB <-  read.csv("input/dataB_2013_BH_June.csv")
```


```{r}
##Remove Cell ####
#Filter by Date
df_date_range <- df_BH %>% filter(Datum>130531 & Datum<130701 )
#write June data to csv
write.csv(df_date_range, file = "dataA_2013_BH_June.csv")

df_date_range2 <- df_BH %>% filter(Datum>130131 & Datum<131201 )
```


```{r}

df_BH_zst1 <-  df_BH %>% filter((Zst == 9171 ))


#plot of all reverse and forward counts at each station in June
ggplot(df_BH_zst1, aes(x=Stunde, y = KFZ_R1)) +   #plot forward direction
  geom_line(aes(color = "R1")) + 
  geom_line(aes(y=KFZ_R2, color = "R2")) +       #plot reverse direction
  facet_wrap(~Zst) + ylab("cars per hour") + theme_bw()  #group by ZST(counting station ID)


```


```{r}
#Finding deviations 

#For all data points with the same station, date, weekday
#Sum hourly values to daily values 
#for Autobahn
df_daily_A <- df_BH %>% group_by( Zst, Datum, Wotag)%>% 
  summarise(SUM_KFZ_R1 = sum(KFZ_R1, na.rm = TRUE), SUM_KFZ_R2 = sum(KFZ_R2, na.rm = TRUE))

#for bundestrasse
df_daily_B <- df_BB %>% group_by( Zst, Datum, Wotag)%>% 
  summarise(SUM_KFZ_R1 = sum(KFZ_R1, na.rm = TRUE), SUM_KFZ_R2 = sum(KFZ_R2, na.rm = TRUE))


```


```{r}

 
#create new column to assign dates a number (1-30)
alldates <- sort(unique(df_daily_A$Datum)) 
alldates_values <- seq(1:length(alldates))
names(alldates_values) <- alldates

#add new index column to df
df_daily_A <- df_daily_A %>% mutate(day = alldates_values[as.character(Datum)]) 
df_daily_B <- df_daily_B %>% mutate(day = alldates_values[as.character(Datum)]) 

```

```{r}
#Filter by station to observe plot 
df_daily_zst_A <- df_daily_A %>% filter((Zst == 9026 ))
#9295 B
#9023 A
                                  
#plot 
ggplot(df_daily_zst_A, aes(x = day)) +
  geom_line(aes(y=SUM_KFZ_R1, color = "R1")) +
  geom_line(aes(y=SUM_KFZ_R2, color = "R2")) + 
  facet_wrap(~Zst) + theme_bw()

df_daily_zst_B <- df_daily_B %>% filter((Zst == 9142 ))
ggplot(df_daily_zst_B, aes(x = day)) +
  geom_line(aes(y=SUM_KFZ_R1, color = "R1")) +
  geom_line(aes(y=SUM_KFZ_R2, color = "R2")) + 
  facet_wrap(~Zst) + theme_bw()

```


```{r}
#calculate relative difference from mean 
#filter data to from groups with same counter device and weekday
#use mutate function to add column with mean of sum KZR1, KZR2
#use mutate again to add column for difference between mean and KZR1 value

df_mean_A <- df_daily_A %>%  group_by( Zst, Wotag) %>% 
  mutate(MEAN_KFZ_R1 = mean(SUM_KFZ_R1, na.rm = TRUE), MEAN_KFZ_R2 = mean(SUM_KFZ_R2, na.rm = TRUE)) %>% 
  mutate(DIFF_R1 = 100*(SUM_KFZ_R1-MEAN_KFZ_R1)/MEAN_KFZ_R1, DIFF_R2 = 100*(SUM_KFZ_R2-MEAN_KFZ_R2)/MEAN_KFZ_R2)

df_mean_B <- df_daily_B %>%  group_by( Zst, Wotag) %>% 
  mutate(MEAN_KFZ_R1 = mean(SUM_KFZ_R1, na.rm = TRUE), MEAN_KFZ_R2 = mean(SUM_KFZ_R2, na.rm = TRUE)) %>% 
  mutate(DIFF_R1 = 100*(SUM_KFZ_R1-MEAN_KFZ_R1)/MEAN_KFZ_R1, DIFF_R2 = 100*(SUM_KFZ_R2-MEAN_KFZ_R2)/MEAN_KFZ_R2)


```


```{r}

#identify columns where relative diff is below 50%
df_dev_A <- df_mean_A %>% filter(DIFF_R1 < -50 | DIFF_R2 < -50 )
df_dev_B <- df_mean_B %>% filter(DIFF_R1 < -50 | DIFF_R2 < -50 )

#identify days with normal traffic patterns
df_dev_low_A <- df_mean_A %>% filter(DIFF_R1 == 0 | DIFF_R2 ==0 )
df_dev_low_B <- df_mean_B %>% filter(DIFF_R1 < -1 | DIFF_R2 < -1 )

#plot deviations at different stations
ggplot(df_dev_A, aes(x=day)) + geom_line(aes(y=DIFF_R1, color = "R1")) +geom_line(aes(y=DIFF_R2, color = "R2")) + facet_wrap(~Zst) + xlim(2,7) + theme_bw()


```

```{r}
df_mean_one_zst <- df_mean_A %>% filter((Zst == 9023 ))

#plot relative difference 
ggplot(df_mean_one_zst, aes(x=day)) + geom_line(aes(y=DIFF_R1, color = "R1")) +geom_line(aes(y=DIFF_R2, color = "R2")) + facet_wrap(~Zst) + theme_bw()

```


```{r}
library(leaflet)

df_lonlats <- read.table("input/Jawe2013.csv", sep = ";", header=TRUE) %>% 
  mutate(lat = as.numeric(gsub(",",".",Koor_WGS84_N)), 
         lon =  as.numeric(gsub(",",".",Koor_WGS84_E)))

selected_Zst <- unique(df_mean_A$Zst)
Zst_lonlats_A <- df_lonlats %>% filter(DZ_Nr %in% selected_Zst)
selected_Zst_B <- unique(df_mean_B$Zst)
Zst_lonlats_B <- df_lonlats %>% filter(DZ_Nr %in% selected_Zst_B)



map_A <- leaflet(Zst_lonlats_A) %>% addTiles() %>% 
  addCircleMarkers(lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "red")

map_A <-  addCircleMarkers(map_A, data =Zst_lonlats_B, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "blue")


```


```{r}
#2.1
arcs <- read.csv("input/Arcs_Flooding.csv")
nodes <- read.csv("input/Nodes_Flooding.csv")

#create map with nodes
m_org <- leaflet(nodes) %>% addTiles() %>% addCircleMarkers(lat = ~LAT ,lng = ~LON, weight = 1, opacity = 1, radius = 3, label = ~as.character(DZ_Nr))


#add arcs(edges)
for(i in 1:nrow(arcs)){
  node_ids <- c(arcs$SOURCE_ID[i], arcs$TARGET_ID[i])
  df_pol <- nodes %>% filter(DZ_Nr %in% node_ids)
  m_org <- addPolylines(m_org, data = df_pol, lng = ~LON, lat = ~LAT, opacity = 0.9, group = "mylines", weight = 2) #, stroke = F)
}


#add station markers
m_org <- addCircleMarkers(m_org, data = Zst_lonlats_A, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "red", radius = 5, fill = FALSE)

m_org <- addCircleMarkers(m_org, data =Zst_lonlats_B, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "blue")

#show map
m_org
```


```{r}

#create network graph from arc and nodes
graph_BH <- graph_from_data_frame(d = arcs[,2:3], vertices = nodes, directed = FALSE)

lo <- as.matrix(nodes[,c("LON","LAT")])

plot(graph_BH, vertex.size = 3, layout=lo, vertex.label = NA)

```

```{r}
#Betweeness Centrality 

#blue = 0 betweenes value, red = highest betweeness value 
pal = colorRampPalette(c("blue","green",'yellow','red'))

between_vals <- centr_betw(graph_BH, directed = FALSE)$res
graphCol_bet = pal(100)[as.numeric(cut(between_vals,breaks = 100))]

plot(graph_BH, vertex.color=graphCol_bet, vertex.size = 5, vertex.label = NA, layout=lo)
```


```{r}
#Remove node where large deviation occurred
arcs_dev <- read.csv("input/Arcs_Flooding_removed9028.csv")
nodes_dev <- read.csv("input/Nodes_Flooding.csv")

#create map with nodes
m_dev <- leaflet(nodes_dev) %>% addTiles() %>% addCircleMarkers(lat = ~LAT ,lng = ~LON, weight = 1, opacity = 1, radius = 3, label = ~as.character(DZ_Nr))


#add arcs(edges)
for(i in 1:nrow(arcs_dev)){
  node_ids <- c(arcs_dev$SOURCE_ID[i], arcs_dev$TARGET_ID[i])
  df_pol <- nodes_dev %>% filter(DZ_Nr %in% node_ids)
  m_dev <- addPolylines(m_dev, data = df_pol, lng = ~LON, lat = ~LAT, opacity = 0.9, group = "mylines", weight = 2) #, stroke = F)
}

m_dev


#add station markers
m_dev <- addCircleMarkers(m_dev, data = Zst_lonlats_A, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "red", radius = 5, fill = FALSE)

m_dev <- addCircleMarkers(m_dev, data =Zst_lonlats_B, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "blue") 

#show map
m_dev


```

```{r}
#create network graph from arc and nodes with deviation removed 
graph_BH_dev <- graph_from_data_frame(d = arcs_dev[,2:3], vertices = nodes_dev, directed = FALSE)

lo <- as.matrix(nodes_dev[,c("LON","LAT")])

plot(graph_BH_dev, vertex.size = 3, layout=lo, vertex.label = NA)

```


```{r}

#Betweeness Centrality with deviaiton removed 

#blue = 0 betweenes value, red = highest betweeness value 
pal = colorRampPalette(c("blue","green",'yellow','red'))

between_vals_dev <- centr_betw(graph_BH_dev, directed = FALSE)$res

graphCol_bet = pal(100)[as.numeric(cut(between_vals_dev,breaks = 100))]

plot(graph_BH_dev, vertex.color=graphCol_bet, vertex.size = 5, vertex.label = NA, layout=lo)


```

```{r}

#Compare betweeness centrality before and after deviation removed 

rel_change <- ifelse(between_vals > 0, (between_vals_dev - between_vals)/between_vals, 0)

#plot igraph:
#use 3 colors: red - decrease, white - no change, blue - increase
graphCol_dev = rep("white",length(rel_change))
nodes_dev <- nodes %>% mutate(rel_change = rel_change, bet= between_vals, betdev = between_vals_dev) %>% mutate(rel_color = ifelse(rel_change==0, "White", ifelse(rel_change<0, "red", "blue")))

plot(graph_BH_dev, vertex.color=nodes_dev$rel_color, vertex.size = 5, vertex.label = NA, layout=lo)


```

```{r}

#plot relative diff on leaflet map
# color scheme: such that we have white for no change
minVal <- abs(min(rel_change))
maxVal <- abs(max(rel_change))
rc1 <- colorRampPalette(colors = c("white", "blue"), space = "Lab")(maxVal*10)
rc2 <- colorRampPalette(colors = c("red", "white"), space = "Lab")(minVal*10)
rampcols <- c(rc2, rc1)
col_pal <- colorNumeric(palette = rampcols, domain =rel_change)


m2 <- leaflet(nodes_dev) %>% addTiles() 

for(i in 1:nrow(arcs_dev)){
  node_ids <- c(arcs_dev$SOURCE_ID[i], arcs_dev$TARGET_ID[i])
  df_pol <- nodes %>% filter(DZ_Nr %in% node_ids)
  m2 <- addPolylines(m2, data = df_pol, lng = ~LON, lat = ~LAT, opacity = 0.9, group = "mylines", weight = 2) 
}
m2 <- addCircleMarkers(m2, lat = ~LAT ,lng = ~LON, weight = 1, opacity = 1, radius = 5,fillOpacity = 1, fillColor = ~col_pal(rel_change), label = ~as.character(rel_change)) %>% addLegend(position = "bottomleft", pal = col_pal, values = ~rel_change, title = as.character("Dev"),opacity = 1) 

m2 <- addCircleMarkers(m2, data = Zst_lonlats_A, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "red", radius = 5, fill = FALSE)

m2 <- addCircleMarkers(m2, data = Zst_lonlats_B, lat = ~lat ,lng = ~lon ,label = ~as.character(DZ_Nr), color = "red", radius = 5, fill = FALSE)

m2

```

```{r}
#Shortest Path Original Network 

node_from <- which(nodes$DZ_Nr == 9023) #9023
node_to <- which(nodes$DZ_Nr == 9109)  #9109

path <- shortest_paths(graph_BH, from = node_from, to = node_to, output = "both")
path_vertices <- unlist(path$vpath)
path_edges <- unlist(path$epath)

graph_short <- graph_BH %>% 
  set_vertex_attr("color", index=path_vertices, value="red") %>% 
  set_edge_attr("color", value="gray") %>% 
  set_edge_attr("color", index=path_edges, value="red")  

lo <- as.matrix(nodes[,c("LON","LAT")])

plot(graph_short, vertex.size = 15, layout=lo, vertex.label.cex = 0.1)


```

```{r}
#Shortest path with arc weight - original map

node_from <- which(nodes$DZ_Nr == 9023) #9023
node_to <- which(nodes$DZ_Nr == 9109)  #9109

path_weight <- shortest_paths(graph_BH, from = node_from, to = node_to, output = "both", weights=arcs$ARC_LENGTH)
path_vertices_w <- unlist(path_weight$vpath)
path_edges_w <- unlist(path_weight$epath)

graph_short <- graph_short %>% 
  set_vertex_attr("color", index=path_vertices_w, value="green") %>% 
  set_edge_attr("color", index=path_edges_w, value="green")

plot(graph_short, vertex.size = 10, layout=lo, vertex.label.cex = 0.1)



```

```{r}
#Shortest path with arc weight in leaflet map - original map 

#color nodes and vertices of shortest path on map 
m_org <- addCircleMarkers(m_org, data = nodes %>% filter(DZ_Nr %in% names(path_vertices_w)), lat = ~LAT ,lng = ~LON , color = "orange", radius = 3, opacity = 1, label = ~as.character(DZ_Nr), fill = FALSE)

m_org
```

```{r}
#Shortest Path Deviation Network 
graph_BH_dev <- graph_from_data_frame(d = arcs_dev[,2:3], vertices = nodes_dev, directed = FALSE)

node_from <- which(nodes$DZ_Nr == 9023) #9023
node_to <- which(nodes$DZ_Nr == 9109)  #9109

path_dev <- shortest_paths(graph_BH_dev, from = node_from, to = node_to, output = "both")
path_vertices_dev <- unlist(path_dev$vpath)
path_edges_dev <- unlist(path_dev$epath)

graph_short_dev <- graph_BH_dev %>% 
  set_vertex_attr("color", index=path_vertices_dev, value="red") %>% 
  set_edge_attr("color", value="gray") %>% 
  set_edge_attr("color", index=path_edges_dev, value="red")  

lo <- as.matrix(nodes[,c("LON","LAT")])

plot(graph_short_dev, vertex.size = 15, layout=lo, vertex.label.cex = 0.1)

#Shortest path with arc weight - deviation map

node_from <- which(nodes$DZ_Nr == 9023) #9023
node_to <- which(nodes$DZ_Nr == 9109)  #9109

path_weight_dev <- shortest_paths(graph_BH_dev, from = node_from, to = node_to, output = "both", weights=arcs_dev$ARC_LENGTH)
path_vertices_w_dev <- unlist(path_weight_dev$vpath)
path_edges_w_dev <- unlist(path_weight_dev$epath)

graph_short_dev <- graph_short_dev %>% 
  set_vertex_attr("color", index=path_vertices_w_dev, value="green") %>% 
  set_edge_attr("color", index=path_edges_w_dev, value="green")

plot(graph_short_dev, vertex.size = 10, layout=lo, vertex.label.cex = 0.1)

#Shortest path with arc weight in leaflet map - deviation map 

#color nodes and vertices of shortest path on map 
m_dev <- addCircleMarkers(m_dev, data = nodes_dev %>% filter(DZ_Nr %in% names(path_vertices_w_dev)), lat = ~LAT ,lng = ~LON , color = "orange", radius = 3, opacity = 1, label = ~as.character(DZ_Nr), fill = FALSE)

m_dev

```


